"object"!=typeof globalThis&&(globalThis=window),function(e){function t(t){for(var r,s,a=t[0],c=t[1],d=t[2],l=0,u=[];l<a.length;l++)s=a[l],Object.prototype.hasOwnProperty.call(o,s)&&o[s]&&u.push(o[s][0]),o[s]=0;for(r in c)Object.prototype.hasOwnProperty.call(c,r)&&(e[r]=c[r]);for(g&&g(t);u.length;)u.shift()();return i.push.apply(i,d||[]),n()}function n(){for(var e,t=0;t<i.length;t++){for(var n=i[t],r=!0,s=1;s<n.length;s++){var c=n[s];0!==o[c]&&(r=!1)}r&&(i.splice(t--,1),e=a(a.s=n[0]))}return e}var r={},s={10:0},o={10:0},i=[];function a(t){if(r[t])return r[t].exports;var n=r[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,a),n.l=!0,n.exports}a.e=function(e){var t=[];s[e]?t.push(s[e]):0!==s[e]&&{16:1}[e]&&t.push(s[e]=new Promise((function(t,n){for(var r=({3:"countries",6:"lang-en",7:"lang-vi"}[e]||e)+"."+{3:"31d6cfe0d16ae931b73c",6:"31d6cfe0d16ae931b73c",7:"31d6cfe0d16ae931b73c",15:"31d6cfe0d16ae931b73c",16:"e9aa0f21ebdfb27b3d52",17:"31d6cfe0d16ae931b73c",18:"31d6cfe0d16ae931b73c"}[e]+".css",o=a.p+r,i=document.getElementsByTagName("link"),c=0;c<i.length;c++){var d=(g=i[c]).getAttribute("data-href")||g.getAttribute("href");if("stylesheet"===g.rel&&(d===r||d===o))return t()}var l=document.getElementsByTagName("style");for(c=0;c<l.length;c++){var g;if((d=(g=l[c]).getAttribute("data-href"))===r||d===o)return t()}var u=document.createElement("link");u.rel="stylesheet",u.type="text/css",u.onload=t,u.onerror=function(t){var r=t&&t.target&&t.target.src||o,i=new Error("Loading CSS chunk "+e+" failed.\n("+r+")");i.code="CSS_CHUNK_LOAD_FAILED",i.request=r,delete s[e],u.parentNode.removeChild(u),n(i)},u.href=o,document.getElementsByTagName("head")[0].appendChild(u)})).then((function(){s[e]=0})));var n=o[e];if(0!==n)if(n)t.push(n[2]);else{var r=new Promise((function(t,r){n=o[e]=[t,r]}));t.push(n[2]=r);var i,c=document.createElement("script");c.charset="utf-8",c.timeout=120,a.nc&&c.setAttribute("nonce",a.nc),c.src=function(e){return a.p+"lazy/"+({3:"countries",6:"lang-en",7:"lang-vi"}[e]||e)+"."+{3:"6f9d987fd0030a15738b",6:"9dc8101bd77c48323d69",7:"4cf7c9a9e570a573804b",15:"f2ab7d3dcc43ed877e44",16:"bac63574c6d4abcd0694",17:"89a7ba22001e87bf5910",18:"2330613e2429d41b6bf0"}[e]+".js"}(e);var d=new Error;i=function(t){c.onerror=c.onload=null,clearTimeout(l);var n=o[e];if(0!==n){if(n){var r=t&&("load"===t.type?"missing":t.type),s=t&&t.target&&t.target.src;d.message="Loading chunk "+e+" failed.\n("+r+": "+s+")",d.name="ChunkLoadError",d.type=r,d.request=s,n[1](d)}o[e]=void 0}};var l=setTimeout((function(){i({type:"timeout",target:c})}),12e4);c.onerror=c.onload=i,document.head.appendChild(c)}return Promise.all(t)},a.m=e,a.c=r,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)a.d(n,r,function(t){return e[t]}.bind(null,r));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="https://zalo-chat-static.zadn.vn/v1/",a.oe=function(e){throw console.error(e),e};var c=this.webpackJsonp=this.webpackJsonp||[],d=c.push.bind(c);c.push=t,c=c.slice();for(var l=0;l<c.length;l++)t(c[l]);var g=d;i.push([15,1,14,0,2]),n()}({15:function(e,t,n){e.exports=n("cKAe")},16:function(e,t){},"1prV":function(e,t){},BtX6:function(e,t,n){window.Promise=n("E2g8").Promise},J9en:function(e,t,n){"use strict";n("rePB")},MBYb:function(e,t){},"Rsr+":function(e,t){},VEPp:function(e,t,n){"use strict";n("w7b/").a.IDB},bzC3:function(e,t){},cKAe:function(e,t,n){"use strict";n.r(t);n("mNvP"),n("ls82"),n("saaK"),n("BtX6"),n("o0oJ"),n("dThN");var r=n("z0WU"),s=(n("vSga"),n("XS0u"));!function(){window.__loadTimer&&clearTimeout(window.__loadTimer);window.__startTime&&n("vbkW").ipcRenderer.send("load-shell-qos",Date.now()-window.__startTime)}();n("FcQj");var o=n("Wos+");perf.record(perf.LOAD_APP_SCRIPT),o.a.init(),r.default.checkSupport(),r.default.showWarningMsg();var i,a=n("jDHv"),c=n("NcTy"),d=n("Y58e");const l=`[${__ZaBUNDLENAME__.toLocaleLowerCase()}]`;class g extends c.a{debug(e){this.disabled||console.debug(l.concat(this.prefix),...this.getContent(e))}log(e){this.disabled||console.debug(l.concat(this.prefix),...this.getContent(e))}error(e){this.disabled||console.debug(l.concat(this.prefix),...this.getContent(e))}}a.a.injectable()(i=function(e,t){return a.a.inject(d.b)(e,void 0,0)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===d.IConfig?Object:d.IConfig])(i=class{constructor(e){this.appConfig=e}createLogger(...e){return new g(this.appConfig,e.map((e=>`[${e}]`)).join(""))}})||i)||i)||i);var u;const m=`[${__ZaBUNDLENAME__.toLocaleLowerCase()}]`;class h extends c.a{debug(e){this.disabled||r.default.stagingLogInfo(m.concat(this.prefix),...this.getContent(e))}log(e){this.disabled||r.default.logCoreInfo(m.concat(this.prefix),...this.getContent(e))}error(e){this.disabled||r.default.logCoreError(m.concat(this.prefix),...this.getContent(e))}}let f=a.a.injectable()(u=function(e,t){return a.a.inject(d.b)(e,void 0,0)}(u=Reflect.metadata("design:type",Function)(u=Reflect.metadata("design:paramtypes",[void 0===d.IConfig?Object:d.IConfig])(u=class{constructor(e){this.appConfig=e}createLogger(...e){return new h(this.appConfig,e.map((e=>`[${e}]`)).join(""))}})||u)||u)||u)||u;a.a.registerSingleton(c.c,f);var p=n("8/YW"),v=(n("jw3m"),n("rePB")),M=n("q1tI"),I=n.n(M),b=n("i8i4"),y=n.n(b),w=n("Jcee");class D extends w.a{constructor(e,t,n,r){super(e,t,n),Object(v.a)(this,"container",void 0),Object(v.a)(this,"component",void 0),this.container=r.container,this.component=r.component}start(){super.start(),this.render()}render(){y.a.render(I.a.createElement(this.component),this.container)}}let j;!function(e){e.Idle="Idle",e.Active="Active"}(j||(j={}));var C=n("AH6j");let T;!function(e){e[e.idle=0]="idle",e[e.active=1]="active"}(T||(T={}));class S extends C.a{constructor(e){super(),Object(v.a)(this,"status",T.active),Object(v.a)(this,"window",void 0),Object(v.a)(this,"idleDelay",void 0),Object(v.a)(this,"minimumIdlePeriod",void 0),Object(v.a)(this,"lastIdleTime",void 0),Object(v.a)(this,"focusStateChangeDebounceTimer",void 0),Object(v.a)(this,"handleDocumentBlur",(()=>{this.resetFocusStateChangeDebounceTimer(),this.focusStateChangeDebounceTimer=setTimeout((()=>{this.setStateToIdle()}),this.idleDelay)})),Object(v.a)(this,"handleDocumentFocus",(()=>{this.resetFocusStateChangeDebounceTimer(),this.setStateToActive()})),this.idleDelay=e.idleDelay,this.minimumIdlePeriod=e.minimumIdlePeriod,this.window=e.window||window,this.lastIdleTime=0,this.focusStateChangeDebounceTimer=null}start(){this.window.addEventListener("blur",this.handleDocumentBlur),this.window.addEventListener("focus",this.handleDocumentFocus)}stop(){this.window.removeEventListener("blur",this.handleDocumentBlur),this.window.removeEventListener("focus",this.handleDocumentFocus)}onIdle(e){return this.addEventListener(j.Idle,e)}setStateToActive(){this.status!==T.idle||(this.status=T.active,this.dispatchEvent(new Event(j.Active)))}setStateToIdle(){if(this.status!==T.active)return;this.isThrottlingIdleState()||(this.lastIdleTime=Date.now(),this.status=T.idle,this.dispatchEvent(new Event(j.Idle)))}isThrottlingIdleState(){return Date.now()-this.lastIdleTime<this.minimumIdlePeriod}resetFocusStateChangeDebounceTimer(){this.focusStateChangeDebounceTimer&&(clearTimeout(this.focusStateChangeDebounceTimer),this.focusStateChangeDebounceTimer=null)}}var E=n("/MKj"),O=n("FK2X"),R=n("emRR"),_=n("xrk1"),A=n("ZBGy"),P=n("I0PH"),x=n("T1Xd"),N=n("uzdi");const L=Object(N.a)();function F(){const e=L.useRecoilSnapshot();return L.setSnapShot(e),null}var B=n("ngSF"),G=n("72hn"),J=n("CzFt"),U=n("dpMp");const K=Object(E.b)((function(e){return{user:e.user,popup:e.popup,chatbox:Object(P.f)(e),status:e.status,profile:e.profile,zaviState:e.zaviState,conversations:e.conversations,chatview:e.chatview}}),(function(e){const t=Object(A.d)(e);return{emitter:Object(A.c)(),dispatch:t}}))(O.c),V=Object(J.sidebarConnect)((e=>({sidebar:{conversation:Object(U.oldConversationSelector)(e)}})))(K),W=()=>I.a.createElement(E.a,{store:J.SidebarStore,context:J.SidebarStoreContext},I.a.createElement(_.d,null,I.a.createElement(E.a,{store:B.a,context:G.a},I.a.createElement(E.a,{store:R.default},I.a.createElement(A.b,null,I.a.createElement(x.a,null,I.a.createElement(F,null),I.a.createElement(V,null)))))));var k;let z=a.a.injectable()(k=function(e,t){return a.a.inject(d.b)(e,void 0,0)}(k=function(e,t){return a.a.inject(c.c)(e,void 0,1)}(k=Reflect.metadata("design:type",Function)(k=Reflect.metadata("design:paramtypes",[void 0===d.IConfig?Object:d.IConfig,void 0===c.ILoggerFactory?Object:c.ILoggerFactory])(k=class extends D{constructor(e,t){super("zalo",e,t,{component:W,container:document.getElementById("app")})}start(){super.start(),this.setupIdleDetector()}setupIdleDetector(){const e=this.config.get("idle_detector"),t=new S(e);t.addEventListener(j.Idle,(()=>{this.setStateToIdle()})),t.addEventListener(j.Active,(()=>this.setStateToActive())),t.start(),this.disposables.add((()=>t.stop())),document.hasFocus()?this.setStateToActive():this.setStateToIdle()}})||k)||k)||k)||k)||k;a.a.registerSingleton(p.c,z);var q=n("mwIZ"),X=n.n(q),H=n("NDmK");a.a.registerSingleton(d.b,class{get(e){return X()(H.c,e)}});var Q,Y=n("fsN4"),$=n("4c4j");let Z=a.a.injectable()(Q=Reflect.metadata("design:type",Function)(Q=Reflect.metadata("design:paramtypes",[String,String])(Q=class{constructor(e,t){this.db=e,this.table=t,Object(v.a)(this,"instance",void 0),this.instance=$.ZDB[e]}index(e){throw new Error("Method not implemented.")}clear(){throw new Error("Method not implemented.")}get(e,t){if(null!=t&&t.index)throw new Error("Method not implemented.");return this.instance.store(this.table).get(e)}getMulti(e,t){throw new Error("Method not implemented.")}getAll(e,t){let n=this.instance.store(this.table);return null!=t&&t.index&&(n=n.index(t.index)),n.getAll(e&&[e.from,e.to],null==t?void 0:t.limit,null==t?void 0:t.direction)}getAllKey(e,t){let n=this.instance.store(this.table);return null!=t&&t.index&&(n=n.index(t.index)),console.debug("store,",n),n.getAllKeys(e&&[e.from,e.to],null==t?void 0:t.limit,null==t?void 0:t.direction)}getAndUpdate(e,t){throw new Error("Method not implemented.")}insert(e,t){throw new Error("Method not implemented.")}put(e,t){throw new Error("Method not implemented.")}insertMulti(e,t){throw new Error("Method not implemented.")}update(e,t){throw new Error("Method not implemented.")}updateMulti(e){throw new Error("Method not implemented.")}delete(e,t){throw new Error("Method not implemented.")}remove(e,t){throw new Error("Method not implemented.")}deleteMulti(e,t){throw new Error("Method not implemented.")}findAndDelete(e,t){throw new Error("Method not implemented.")}count(e,t){let n=this.instance.store(this.table);return null!=t&&t.index&&(n=n.index(t.index)),n.count(e&&[e.from,e.to],null==t?void 0:t.limit,null==t?void 0:t.direction)}})||Q)||Q)||Q;a.a.registerFactory(Y.TCoreDB,(()=>({message:new Z("Core","message")})));var ee,te=n("OI//"),ne=n("Gm1y");let re=a.a.injectable()(ee=class{async get(e){return ne.a.getGroupByIdSync(e)}async getAll(){return await ne.a.getGroupsListSync()}})||ee;var se,oe=n("Ti+8");let ie=a.a.injectable()(se=function(e,t){return a.a.inject(oe.g)(e,void 0,0)}(se=function(e,t){return a.a.inject(te.e)(e,void 0,1)}(se=function(e,t){return a.a.inject(c.c)(e,void 0,2)}(se=Reflect.metadata("design:type",Function)(se=Reflect.metadata("design:paramtypes",[void 0===oe.IMessageManager?Object:oe.IMessageManager,void 0===te.IGroupRepository?Object:te.IGroupRepository,void 0===c.ILoggerFactory?Object:c.ILoggerFactory])(se=class{constructor(e,t,n){this.messageManager=e,this.groupRepository=t,Object(v.a)(this,"logger",void 0),this.logger=n.createLogger("group-manager")}getAll(){return this.groupRepository.getAll().then((e=>e.map((e=>new te.a(e,this.messageManager))))).catch((e=>(this.logger.error((()=>["getAll error. return [].",{reason:e}])),[])))}})||se)||se)||se)||se)||se)||se;a.a.registerSingleton(te.e,re),a.a.registerSingleton(te.d,ie);var ae=n("MqnV");class ce{constructor(e,t,n){this.entity=e,this.conversationManager=t,this.messageManager=n}get id(){return this.entity.userId}get isGroup(){return this.entity.isGroup}get isPinned(){return this.entity.pinned>0}get isMuted(){return this.conversationManager.isMuted(this.entity.userId)}async getLastMessage(){return this.messageManager.getLastMessage(this.entity.userId)}async countTotalMessages(){return this.messageManager.countMessages(this.entity.userId)}}var de,le=n("L93N");let ge=a.a.injectable()(de=function(e,t){return a.a.inject(ae.c)(e,void 0,0)}(de=function(e,t){return a.a.inject(oe.g)(e,void 0,1)}(de=Reflect.metadata("design:type",Function)(de=Reflect.metadata("design:paramtypes",[Object,void 0===oe.IMessageManager?Object:oe.IMessageManager])(de=class{constructor(e,t){this.conversationRepository=e,this.messageManager=t}async get(e){const t=await this.conversationRepository.get(e).catch((()=>{}));if(t)return new ce(t,this,this.messageManager)}isPinned(e){return this.conversationRepository.get(e).then((e=>!(null==e||!e.pinned))).catch((()=>!1))}isMuted(e){var t;return!(null===(t=le.c.muteManager)||void 0===t||!t.isMuted(e))}})||de)||de)||de)||de)||de;var ue;let me=a.a.injectable()(ue=class{get(e){return le.c.getById(e)}})||ue;a.a.registerSingleton(ae.c,me),a.a.registerSingleton(ae.b,ge);var he,fe=n("xXTn"),pe=n("h5Sw");const ve="999999999999999999999",Me="9999999999999999";let Ie=a.a.injectable()(he=function(e,t){return a.a.inject(Y.TCoreDB)(e,void 0,0)}(he=Reflect.metadata("design:type",Function)(he=Reflect.metadata("design:paramtypes",[void 0===Y.CoreDB?Object:Y.CoreDB])(he=class{constructor(e){this.coreDb=e}countTotalMessages(){return this.coreDb.message.count()}async countMessagesInRange(e,t){t={from:[e,...t.from],to:[e,...t.to]};return await this.coreDb.message.count(t,{index:"userId_sendDttm_msgId"})}async findPrevMessagesFromMsgId(e,t,n,r,s){return this.coreDb.message.getAll({from:[e,"",r],to:[e,n,t]},{index:"userId_sendDttm_msgId",limit:s,direction:fe.CursorDirection.PREV}).then((e=>e.filter((e=>!(t&&e.msgId>t)&&!(r&&e.msgId<r)))))}async findPrevMessageKeysFromMsgId(e,t,n){return this.coreDb.message.getAllKey({from:[e,"",""],to:[e,Me,t]},{index:"userId_sendDttm_msgId",limit:n,direction:fe.CursorDirection.PREV})}async findMessage(e,t){if("function"==typeof t){return(await this.coreDb.message.getAll({from:[e,"",""],to:[e,Me,ve]},{index:"userId_sendDttm_msgId",limit:1,direction:fe.CursorDirection.PREV,predicate:t}))[0]}return(await this.coreDb.message.getAll({from:[e,"",""],to:[e,Me,ve]},{index:"userId_sendDttm_msgId",limit:1,direction:fe.CursorDirection.PREV,filter:t}))[0]}async saveMessages(e){await s.default.setMessage(e,!0),pe.a.receiveImportantMessage(e)}})||he)||he)||he)||he;var be,ye=n("bJsu"),we=n("bdot");let De=a.a.injectable()(be=function(e,t){return a.a.inject(oe.h)(e,void 0,0)}(be=function(e,t){return a.a.inject(c.c)(e,void 0,1)}(be=Reflect.metadata("design:type",Function)(be=Reflect.metadata("design:paramtypes",[void 0===oe.IMessageRepository?Object:oe.IMessageRepository,void 0===c.ILoggerFactory?Object:c.ILoggerFactory])(be=class{constructor(e,t){this.messageRepository=e,Object(v.a)(this,"logger",void 0),this.logger=t.createLogger("msg-manager")}countMessages(e){return this.messageRepository.countMessagesInRange(e,{from:[oe.f,oe.e],to:[oe.d,oe.c]})}countTotalMessages(){return this.messageRepository.countTotalMessages()}async countMessagesInRange(e,t){const n=t.from&&""!==t.from?await this.getMessageById(t.from):void 0,r=t.to&&""!==t.to?await this.getMessageById(t.to):void 0;return this.messageRepository.countMessagesInRange(e,{from:n?[n.sendDttm,n.msgId]:[oe.f,oe.e],to:r?[r.sendDttm,r.msgId]:[oe.f,oe.e]})}getLastMessage(e){return we.b.getPreviewMessage(e).then((e=>e.previewMsg&&new ye.e(e.previewMsg))).catch((e=>{this.logger.error((()=>["getLastMessage err",{reason:e}]))}))}async findPrevMessagesFromMsgId(e,t){const n=t.maxMsgId&&""!==t.maxMsgId?await this.getMessageById(t.maxMsgId):void 0;return this.messageRepository.findPrevMessagesFromMsgId(e,t.maxMsgId||oe.c,(null==n?void 0:n.sendDttm)||oe.d,t.minMsgId||oe.e,t.limit||50).then((e=>e.map((e=>new ye.e(e))))).catch((e=>(this.logger.error((()=>["findPrevMessagesFromMsgId err",{reason:e}])),[])))}findPrevMessageKeysFromMsgId(e,t){return this.messageRepository.findPrevMessageKeysFromMsgId(e,t.msgId||oe.c,t.limit||50).catch((e=>(this.logger.error((()=>["findPrevMessageKeysFromMsgId err",{reason:e}])),[])))}async getMessageById(e){const t=await s.default.getMessagesByIds([e]);if(t[e])return t[e]}})||be)||be)||be)||be)||be;a.a.registerSingleton(oe.h,Ie),a.a.registerSingleton(oe.g,De);var je,Ce=n("fl14"),Te=n("t3h5");let Se=a.a.injectable()(je=Reflect.metadata("design:type",Function)(je=Reflect.metadata("design:paramtypes",[])(je=class{constructor(){}get(e){return Te.a.getSegmentByConvId(e)}})||je)||je)||je;var Ee,Oe=n("nPWC"),Re=n("npvr"),_e=n("D8Ji");let Ae=a.a.injectable()(Ee=function(e,t){return a.a.inject(Ce.f)(e,void 0,0)}(Ee=Reflect.metadata("design:type",Function)(Ee=Reflect.metadata("design:paramtypes",[void 0===Ce.ICloudSegmentRepository?Object:Ce.ICloudSegmentRepository])(Ee=class{constructor(e){this.segmentRepository=e}get(e){return this.segmentRepository.get(e).then((e=>e&&new Oe.a(e))).catch((e=>{}))}async createOrExtendSegment(e,t){const n=await this.segmentRepository.get(e);n.cloudSegmentCheck=_e.a.mergeNewSegment(t.verifiedRange,null==n?void 0:n.cloudSegmentCheck),n.maxCloudMsgId=Math.max(n.maxCloudMsgId||0,t.verifiedRange[1]),Te.a.setSegmentCacheByConvId(e,n),await Re.b.updateSegmentDB(e,n)}})||Ee)||Ee)||Ee)||Ee;var Pe,xe=n("VTBJ"),Ne=n("1pet"),Le=n("fBUP"),Fe=n("kCOK"),Be=n("jVQv");let Ge=a.a.injectable()(Pe=function(e,t){return a.a.inject(d.b)(e,void 0,0)}(Pe=Reflect.metadata("design:type",Function)(Pe=Reflect.metadata("design:paramtypes",[void 0===d.IConfig?Object:d.IConfig])(Pe=class{constructor(e){this.config=e}get settings(){return this.config.get("cloud.auto_download")}async crawlMissingMessage(e,t={nRetry:0,count:50}){let n=e.conversationId;n.startsWith("g")&&(n=n.slice(1));const r=`${n}_${e.requestMsgId}`;let s=this.settings.limit.minMsgDttm,o=this.settings.limit.maxMsgFirstSegment;const i={groupId:n,fromMsgId:e.requestMsgId,globalMsgIds:e.globalMsgIds,curTotalMsgs:e.curTotalMsgs,tsJoinGroup:e.tsJoinGroup,minMsgTs:s,maxTotalSyncMsg:o};return await Le.a.crawlMissingMessage(r,i,{requestTimeout:this.settings.fetching.timeout,count:t.count,nRetry:t.nRetry,usePostApi:!0}).then((e=>Object(Fe.a)(e))).then((e=>{try{return JSON.parse(e)}catch(t){throw{error_code:-1,error_message:"invalid response"}}})).then((e=>{const t=e[n];if(t.error>0)throw{error_code:t.error,error_message:"inner error"};return t})).catch((e=>{if("number"==typeof e.error_code){let n=e.data;try{n=JSON.parse(n)}catch(t){}throw new Be.a(e.error_code,n,e.error_message)}throw e}))}})||Pe)||Pe)||Pe)||Pe;var Je,Ue=n("EO3V"),Ke=n("enz2");const Ve={totalMsgCount:0,fetchedMsgCount:0,serverMsgCount:0,newMsgCount:0,phaseDone:!1,isFilteredByTimeJoin:!1,done:!0,tsJoinGroup:"0"};let We=a.a.injectable()(Je=function(e,t){return a.a.injectToken(Ge)(e,void 0,0)}(Je=function(e,t){return a.a.inject(Ce.e)(e,void 0,1)}(Je=function(e,t){return a.a.inject(oe.h)(e,void 0,2)}(Je=function(e,t){return a.a.inject(oe.g)(e,void 0,3)}(Je=function(e,t){return a.a.inject(c.c)(e,void 0,4)}(Je=Reflect.metadata("design:type",Function)(Je=Reflect.metadata("design:paramtypes",[void 0===Ge?Object:Ge,void 0===Ce.ICloudSegmentManager?Object:Ce.ICloudSegmentManager,void 0===oe.IMessageRepository?Object:oe.IMessageRepository,void 0===oe.IMessageManager?Object:oe.IMessageManager,void 0===c.ILoggerFactory?Object:c.ILoggerFactory])(Je=class{constructor(e,t,n,r,s){this.api=e,this.segmentManager=t,this.messageRepository=n,this.messageManager=r,Object(v.a)(this,"logger",void 0),this.logger=s.createLogger("cld-msg","manager")}async crawlMissingMessage(e,t,n){const r=await this.segmentManager.get(e),s=(()=>{var e;let t=n.minMsgId&&Number.parseInt(n.minMsgId);return r&&r.lastDeletedMsgID&&(t=t?Math.max(r.lastDeletedMsgID,t):r.lastDeletedMsgID),null===(e=t)||void 0===e?void 0:e.toString()})(),o="0"!==t,i=o?n.count+1:n.count;if(o&&t<=s)return Ve;const a=await this.messageManager.findPrevMessagesFromMsgId(e,{maxMsgId:"0"!==t?t:void 0,minMsgId:s,limit:i}).then((e=>e.map((e=>e.entity)))),c=new Set;a.forEach((e=>{try{const t=Number.parseInt(e.msgId);Number.isInteger(t)&&c.add(t.toString())}catch(t){}}));const d=Array.from(c.values()),l=await this.api.crawlMissingMessage({conversationId:e,requestMsgId:t,globalMsgIds:d,curTotalMsgs:n.curTotalMsgs,tsJoinGroup:n.tsJoinGroup},{nRetry:n.nRetry,count:n.count});if(0===l.groupMsgs.length&&"0"===l.maxMsgId)return Ve;let g=Ue.a.checkDupMessageFromCloud(e,l.groupMsgs);s&&s>"0"&&(g=g.filter((e=>e.msgId>s)));const u=[...a,...g];if(0===u.length)return Ve;const m=Number.parseInt(l.lastMsgId,10);let h=Number.parseInt(t);const f=Ue.a.findMinMaxGroupMsg(u,h,m,null==r?void 0:r.lastDeletedMsgID),{groupMsgsToView:p,groupMsgsAddDb:v,groupMsgsSearch:M}=Ke.a.findMsgsAddDb(t,g,[],a,Object(xe.a)({apiType:2,conversationId:e},f));v.forEach((e=>{e.src=Ne.MSG_SRC.AUTO_LOADER})),await this.messageRepository.saveMessages(v),await Ke.a.updateSearchV3(M,e);const I=!!l.isFilteredByPhase,b=l.maxMsgId;f.minMsgId&&f.maxMsgId&&await this.segmentManager.createOrExtendSegment(e,{verifiedRange:[f.minMsgId,f.maxMsgId]});let y="0";Number.isInteger(Number.parseInt(l.tsJoinGroup))?y=l.tsJoinGroup:this.logger.error((()=>["api res invalid ts join group",{tsJoinGroup:l.tsJoinGroup}]));const w=!!l.isFilteredByTimeJoin,D={totalMsgCount:p.length,fetchedMsgCount:v.length,serverMsgCount:g.length,newMsgCount:v.length,phaseDone:I,isFilteredByTimeJoin:w,done:!(I||!w&&l.hasMore),minMsgId:s,maxMsgId:b.toString(),tsJoinGroup:y};return this.logger.log((()=>["[auto-dl-msg] crawl result",D])),D}})||Je)||Je)||Je)||Je)||Je)||Je)||Je)||Je;a.a.registerSingleton(Ce.f,Se),a.a.registerSingleton(Ce.e,Ae),a.a.registerSingleton(Ce.d,We);n("Q/Ir")},fsN4:function(e,t,n){"use strict";n.d(t,"TCoreDB",(function(){return o}));var r=n("jDHv"),s=n("bzC3");n.o(s,"CoreDB")&&n.d(t,"CoreDB",(function(){return s.CoreDB}));const o=Object(r.b)("core-db")},i3ih:function(e,t){},jw3m:function(e,t,n){},"o/Fe":function(e,t){},o0oJ:function(e,t,n){(function(e){const t={};function n(e){return t[e]||(t[e]=0),t[e]+=1,100*e+t[e]}if(!e.perf){let t;t=()=>Date.now();const r={STARTUP:n(1),MIGRATION_DONE:n(2),MAIN_SCRIPT:n(2),LOADED_MAIN_SCRIPT:n(3),MAIN_APP_READY:n(3),LOADED_STARTUP_SCRIPT:n(2),STARTUP_BEFORE_HEAVY:n(3),CREATE_MAIN_WINDOW:n(3),SHOW_MAIN_WINDOW:n(3),MAIN_WINDOW_LOADING:n(3),MAIN_WINDOW_LOADED:n(3),APP_STARTUP:n(2),LOAD_APP_SCRIPT:n(3),APP_DID_MOUNT:n(3),CHATBOX_DID_MOUNT:n(3),SELECT_CONVERSATION:n(1),SELECTED_CONVERSATION:n(2)};e.perf={...r,perfRecords:[],record:n=>{n||(n=0);const r=[n,t()];e.perf.perfRecords.push(r)}}}}).call(this,n("kjmW"))},"w7b/":function(e,t,n){"use strict";let r,s,o,i,a,c;n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a})),function(e){e.NEXT="next",e.NEXT_UNIQUE="nextunique",e.PREV="prev",e.PREV_UNIQUE="prevunique"}(r||(r={})),function(e){e.integer="integer",e.float="float",e.string="string",e.boolean="boolean",e.json="json",e.blob="blob"}(s||(s={})),function(e){e.READONLY="readonly",e.READWRITE="readwrite"}(o||(o={})),function(e){e[e.BLOCKING=0]="BLOCKING",e[e.NON_BLOCKING=50]="NON_BLOCKING",e[e.LOW=100]="LOW",e[e.IDLE=250]="IDLE",e[e.NEVER_TIMEOUT=1e3]="NEVER_TIMEOUT"}(i||(i={})),function(e){e[e.IDB=0]="IDB",e[e.SQLite=1]="SQLite"}(a||(a={})),function(e){e[e.BeginTransaction=0]="BeginTransaction",e[e.CommitTransaction=1]="CommitTransaction",e[e.Clear=2]="Clear",e[e.Get=3]="Get",e[e.GetAndUpdate=4]="GetAndUpdate",e[e.GetMulti=5]="GetMulti",e[e.GetAll=6]="GetAll",e[e.GetAllKey=7]="GetAllKey",e[e.Insert=8]="Insert",e[e.InsertMulti=9]="InsertMulti",e[e.Update=10]="Update",e[e.UpdateMulti=11]="UpdateMulti",e[e.Delete=12]="Delete",e[e.DeleteMulti=13]="DeleteMulti",e[e.FindAndDelete=14]="FindAndDelete",e[e.Count=15]="Count"}(c||(c={}))},xXTn:function(e,t,n){"use strict";n("VEPp");var r=n("w7b/");n.d(t,"CursorDirection",(function(){return r.b}));n("i3ih"),n("J9en"),n("1prV"),n("MBYb"),n("o/Fe"),n("Rsr+")}});